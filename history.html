<!DOCTYPE html>
<html>
  	<head>
	  	<!-- Bootstrap -->
	  	<link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
		<script src="assets/jQuery/jquery-3.3.1.min.js"></script>

		<!-- check session -->
		<script>
			$.ajax({
	            type: "POST",
	            url: "phpscript/checkSession.php",
	            success: function(res){
	                if(res == "0") {
	                    window.location.href = "index.html"; 
	                }
	            },
	            error: function(res) {
	            	console.log(res);
	            }
		    });
		</script>
		<script src="assets/jquery.csv.js"></script>
		<script src="assets/moment.js"></script>
		<script src="assets/moment-timezone-with-data.js"></script>
		<script src="assets/js/bootstrap.min.js"></script>
	  	<link rel="stylesheet" href="assets/css/custom.css"/>
	    <meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">

	    <!-- no cache -->
	    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
	    
	    <title>UPS Dashboard History</title>
  	</head>
  	<body>
	  	<script type="text/javascript" src="assets/Chartjs/dist/Chart.min.js"></script>
		<div id="navbar"></div>
		 <!-- include navbar -->
	    <script type="text/javascript">
	    	$(function() {
			    $("#navbar").load("navbar.html");
			});
	    </script>

		<div class="container">
			<canvas id="histChart" width="500" height="200" border="0"></canvas>
			<div align="center">
	    		<button class="btn btn-default" id="1d">1 Hari</button>
	    		<button class="btn btn-default" id="7d">7 Hari</button>
	    		<button class="btn btn-default" id="14d">14 Hari</button>
	    		<button class="btn btn-default" id="30d">1 Bulan</button>
	    	</div>
	    	<br>
	    	
		  	<div>
		  		<h4 align="center">Download Log Files</h4>
		  		<table class="table">
		  			<thead>
		  				<th>File Name</th>
		  				<th>Action</th>
		  			</thead>
		  			<tbody id="logTable">
		  			</tbody>
		  		</table>
		  	</div>
		</div>

		<script>
			var fileDir;
			readDate();

			var tempData = [];
			var arusData = [];
			var batData = [];
			readAll();
			var tempChartData = generateChartData(tempData);
			var arusChartData = generateChartData(arusData);
			var batChartData = generateChartData(batData);
			// console.log(batChartData);
			var histChart;
			firstDraw();
			readLogDir();

			setInterval(readAll, 300000);
			setInterval(function() { generateChartData(tempData); }, 300000);
			setInterval(function() { generateChartData(arusData); }, 300000);
			setInterval(function() { generateChartData(batData); }, 300000);
			setInterval(firstDraw, 300000);

			function readAll() {
				var logData;
				$.ajax({
				  type: "GET",  
				  url: "log/2018-10.csv",
				  dataType: "text",
				  async: false,
				  success: function(response)  
				  {
					logData = $.csv.toObjects(response);
				  }   
				});
				var i = 0;
				while (logData[i] != null) {
					tempData[i] = (({ time, temperature }) => ({ time, temperature }))(logData[i]);
					arusData[i] = (({ time, arus }) => ({ time, arus }))(logData[i]);
					batData[i] = (({ time, battery }) => ({ time, battery }))(logData[i]);
					i++;
				}
				// console.log(tempData);
			}

			function readDate() {
				var now = moment().tz('Asia/Jakarta');
				var year = (moment(now).year()).toString();
				var month = (moment(now).month()+1).toString();
				fileDir = 'log/'+year+'-'+month+'.csv';
			}

			function generateChartData(data) {
				var data30 = [];
				var data14 = [];
				var data7 = [];
				var data1 = [];
				var counter30 = 0;
				var counter14 = 0;
				var counter7 = 0;
				var counter1 = 0;
				// get only 1st data on every 5 minute(s)
				// get current datetime
				var now = moment();
				var now14 = moment(now).subtract(14, 'd');
				var now7 = moment(now).subtract(7, 'd');
				var now1 = moment(now).subtract(1, 'd');
				// get hour from current moment
				var h = moment(now).hour();
				var i = 0;
				// read file from top
				while (data[i] != null ) {
					var logDate = moment(data[i].time).format('YYYY-MM-DD HH:mm:ss');
					// masuk semua ke data 30 hari
					if (moment(logDate).hour() == h) {
						data30[counter30] = data[i];
						counter30++;
					}

					// cek kalau tanggal log masuk 14 hari dr sekarang
					if (moment(logDate).isSameOrAfter(now14) && moment(logDate).hour() == h) {
						data14[counter14] = data[i];
						counter14++;
					}

					// cek kalau tanggal log masuk 7 hari dr sekarang
					if (moment(logDate).isSameOrAfter(now7) && moment(logDate).hour() == h) {
						data7[counter7] = data[i];
						counter7++;
					}

					// cek kalau tanggal log masuk 1 hari dr sekarang
					if (moment(logDate).isSameOrAfter(now1)) {
						data1[counter1] = data[i];
						counter1++;
					}

					// change h to current logdata hours
					h = moment(logDate).hour() + 1;

					// iterasi
					i++;
				}

				var allChartData = [data30, data14, data7, data1];
				console.log(allChartData);
				// console.log(allChartData);
				return allChartData;
			}

			function firstDraw() {
				var ctx = document.getElementById("histChart").getContext('2d');
			    var lineChartData = {
			    	labels :  tempChartData[3].map(function (a) { return a.time; }),
			    	datasets : [
			    		{
			    			label : "Temperatur",
			    			data : tempChartData[3].map(function (a) { return a.temperature; }),
			    			fill : false, 
			    			borderColor : 'rgb(75, 192, 192)',
			    			lineTension : 0.1
			    		},
			    		{
			    			label : "Arus",
			    			data : arusChartData[3].map(function (a) { return a.arus; }),
			    			fill : false, 
			    			borderColor : 'rgb(255, 153, 58)',
			    			lineTension : 0.1
			    		},
			    		{
			    			label : "Baterai",
			    			data : batChartData[3].map(function (a) { return a.battery; }),
			    			fill : false, 
			    			borderColor : 'rgb(155, 66, 244)',
			    			lineTension : 0.1
			    		}
		    		]
			    };
				histChart = new Chart(ctx, {
			        type: 'line',
			        data: lineChartData
			    });
			}
			
			function readLogDir() {
				$.ajax({
					type: "GET",  
					url: "phpscript/readLogDir.php",
					dataType: "text",
					// async: false,
					success: function(response)  
					{
						var obj = JSON.parse(response)
						var tbody = document.getElementById('logTable');
						for (var i = 0; i < Object.keys(obj).length; i++) {
						    var tr = "<tr>";
						    if(obj[i] != "sensor-now.txt") {
						    	tr += 
						    	"<td>" + obj[i] + "</td>" + "<td><form method='get' action='log/" + obj[i] + "'><button class='btn btn-default' type='submit'>Download</button></form></td></tr>";
						    		// console.log(tr);
    							tbody.innerHTML += tr;
						    }
						}
					}   
				});
			}

			$("#1d").click(function() {
			    var data = histChart.config.data;
			    data.labels = tempChartData[3].map(function (a) { return a.time; });
			    data.datasets[0].data = tempChartData[3].map(function (a) { return a.temperature; });
			    data.datasets[1].data = arusChartData[3].map(function (a) { return a.arus; });
			    data.datasets[2].data = batChartData[3].map(function (a) { return a.battery; });
			    histChart.update();
			});

			$("#7d").click(function() {
			    var data = histChart.config.data;
			    data.labels = tempChartData[2].map(function (a) { return a.time; });
			    data.datasets[0].data = tempChartData[2].map(function (a) { return a.temperature; });
			    data.datasets[1].data = arusChartData[2].map(function (a) { return a.arus; });
			    data.datasets[2].data = batChartData[2].map(function (a) { return a.battery; });
			    histChart.update();
			});

			$("#14d").click(function() {
			    var data = histChart.config.data;
			    data.labels = tempChartData[1].map(function (a) { return a.time; });
			    data.datasets[0].data = tempChartData[1].map(function (a) { return a.temperature; });
			    data.datasets[1].data = arusChartData[1].map(function (a) { return a.arus; });
			    data.datasets[2].data = batChartData[1].map(function (a) { return a.battery; });
			    histChart.update();
			});

			$("#30d").click(function() {
			    var data = histChart.config.data;
			    data.labels = tempChartData[0].map(function (a) { return a.time; });
			    data.datasets[0].data = tempChartData[0].map(function (a) { return a.temperature; });
			    data.datasets[1].data = arusChartData[0].map(function (a) { return a.arus; });
			    data.datasets[2].data = batChartData[0].map(function (a) { return a.battery; });
			    histChart.update();
			});
			
	    </script>

	</body>
</html>
