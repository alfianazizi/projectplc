<!DOCTYPE html>
<html>
  <head>
  	<!-- Bootstrap -->
  	<link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
	<script src="assets/jQuery/jquery-3.3.1.min.js"></script>
	<script src="assets/jquery.csv.js"></script>
	<script src="assets/moment.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
  	<link rel="stylesheet" href="assets/css/custom.css"/>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UPS Dashboard History</title>
  </head>
  <body>
  	<script type="text/javascript" src="assets/Chartjs/dist/Chart.min.js"></script>
	<div id="navbar"></div>
	 <!-- include navbar -->
    <script type="text/javascript">
    	$(function() {
		    $("#navbar").load("navbar.html");
		});
    </script>

	<div class="container">
		<canvas id="histChart" width="500" height="200" border="0"></canvas>
		<div align="center">
    		<button class="btn btn-default" id="1d">1 Hari</button>
    		<button class="btn btn-default" id="7d">7 Hari</button>
    		<button class="btn btn-default" id="14d">14 Hari</button>
    		<button class="btn btn-default" id="30d">1 Bulan</button>
    	</div>
	</div>

	<script>
		var tempData;
		var arusData;
		var batData;
		readAll();
		var tempChartData = generateChartData(tempData);
		var arusChartData = generateChartData(arusData);
		var batChartData = generateChartData(batData);
		var histChart;
		firstDraw();

		function readAll() {
			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-temp.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				tempData = $.csv.toObjects(response);
			  }   
			});

			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-arus.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				arusData = $.csv.toObjects(response);
			  }   
			});

			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-bat.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				batData = $.csv.toObjects(response);
			  }   
			});
		}

		function generateChartData(data) {
			var data30 = [];
			var data14 = [];
			var data7 = [];
			var data1 = [];
			var counter30 = 0;
			var counter14 = 0;
			var counter7 = 0;
			var counter1 = 0;
			// get only 1st data on every 5 minute(s)
			// get current datetime
			var now = new Date();
			var m1 = now.getMinutes();
			var h7 = now.getHours();
			var h14 = now.getHours();
			var h30 = now.getHours();
			for (var i = 1; i < data.length; i++) {
				var oldDate = moment(data[i].time).format('YYYY-MM-DD HH:mm:ss');
				//cek untuk ambil data per 14 hari
				if(i >= data.length-242000) {
					//cek untuk ambil data per 7 hari
					if(i >= data.length-121000) {
						//cek untuk ambil data 1 hari
						if(i >= data.length-17300) {
							if(data[i].time.substring(14,16) == m1) {
								data1[counter1] = data[i];
								var newDate = moment(oldDate).add(5, 'm').toDate();
								m1 = moment(newDate).minutes().toString();
								// console.log(m1);
								counter1++;
							}
						}
						if(data[i].time.substring(11,13) == h7) {
							data7[counter7] = data[i];
							var newDate = moment(oldDate).add(1, 'h').toDate();
							h7 = moment(newDate).hours().toString();
							counter7++;
						}
					}
					if(data[i].time.substring(11,13) == h14) {
						data14[counter14] = data[i];
						var newDate = moment(oldDate).add(1, 'h').toDate();
						h14 = moment(newDate).hours().toString();
						counter14++;
					}
				}
				if(data[i].time.substring(11,13) == h30) {
					data30[counter30] = data[i];
					var newDate = moment(oldDate).add(1, 'h').toDate();
					h30 = moment(newDate).hours().toString();
					counter30++;
				}
			}

			var allChartData = [data30, data14, data7, data1];
			// console.log(allChartData);
			return allChartData;
		}

		function firstDraw() {
			var ctx = document.getElementById("histChart").getContext('2d');
		    var lineChartData = {
		    	labels :  tempChartData[3].map(function (a) { return a.time; }),
		    	datasets : [
		    		{
		    			label : "Temperatur",
		    			data : tempChartData[3].map(function (a) { return a.temperature; }),
		    			fill : false, 
		    			borderColor : 'rgb(75, 192, 192)',
		    			lineTension : 0.1
		    		},
		    		{
		    			label : "Arus",
		    			data : arusChartData[3].map(function (a) { return a.arus; }),
		    			fill : false, 
		    			borderColor : 'rgb(255, 153, 58)',
		    			lineTension : 0.1
		    		},
		    		{
		    			label : "Baterai",
		    			data : batChartData[3].map(function (a) { return a.battery; }),
		    			fill : false, 
		    			borderColor : 'rgb(155, 66, 244)',
		    			lineTension : 0.1
		    		}
	    		]
		    };
			histChart = new Chart(ctx, {
		        type: 'line',
		        data: lineChartData
		    });
		}
		

		$("#1d").click(function() {
		    var data = histChart.config.data;
		    data.datasets[0].data = tempChartData[3].map(function (a) { return a.temperature; });
		    data.datasets[1].data = tempChartData[3].map(function (a) { return a.arus; });
		    data.datasets[2].data = tempChartData[3].map(function (a) { return a.battery; });
		    histChart.update();
		});

		$("#7d").click(function() {
		    var data = histChart.config.data;
		    data.datasets[0].data = tempChartData[2].map(function (a) { return a.temperature; });
		    data.datasets[1].data = tempChartData[2].map(function (a) { return a.arus; });
		    data.datasets[2].data = tempChartData[2].map(function (a) { return a.battery; });
		    histChart.update();
		});

		$("#14d").click(function() {
		    var data = histChart.config.data;
		    data.datasets[0].data = tempChartData[1].map(function (a) { return a.temperature; });
		    data.datasets[1].data = tempChartData[1].map(function (a) { return a.arus; });
		    data.datasets[2].data = tempChartData[1].map(function (a) { return a.battery; });
		    histChart.update();
		});

		$("#30d").click(function() {
		    var data = histChart.config.data;
		    data.datasets[0].data = tempChartData[0].map(function (a) { return a.temperature; });
		    data.datasets[1].data = tempChartData[0].map(function (a) { return a.arus; });
		    data.datasets[2].data = tempChartData[0].map(function (a) { return a.battery; });
		    histChart.update();
		});
		
    </script>

  </body>
</html>
