<!DOCTYPE html>
<html>
  <head>
  	<!-- Bootstrap -->
  	<link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
	<script src="assets/jQuery/jquery-3.3.1.min.js"></script>
	<script src="assets/jquery.csv.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
  	<link rel="stylesheet" href="assets/css/custom.css"/>
  	<!-- <meta http-equiv="refresh" content="5" /> -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UPS Dashboard</title>
  </head>
  <body>
  	<script type="text/javascript" src="assets/Chartjs/dist/Chart.min.js"></script>
   	<div id="navbar"></div>
   	 <!-- include navbar -->
    <script type="text/javascript">
    	$(function() {
		    $("#navbar").load("navbar.html");
		});
    </script>
  	<div class="container">
	<div class="row">
		<div class="col-sm-3">
			<div class="panel panel-default">
				<div class="panel-heading" align="center" style="background-color: #7e57c2;">Current Temperature</div>
				<div class="panel-body" style="background-color: #9575cd;" id="temp">
					<h1 align="center" id="currentTemp"></h1>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="panel panel-default">
				<div class="panel-heading" align="center" style="background-color: #f57c00;">Current Voltage</div>
				<div class="panel-body" style="background-color: #ffcc80;" id="vol">
					<h1 align="center" id="currentArus"></h1>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="panel panel-default">
				<div class="panel-heading" align="center" style="background-color: #2196f3;">Current Battery Capacity</div>
				<div class="panel-body" style="background-color: #90caf9;" id="cap">
					<h1 align="center" id="currentBat"></h1>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="panel panel-default">
				<div class="panel-heading" align="center" style="background-color: #4caf50;">Battery Remaining</div>
				<div class="panel-body" style="background-color: #81c784;">
					<h1 align="center">10 hours</h1>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-sm-12">
			<div class="panel panel-default">
				<div class="panel-heading">Last 60 Minutes Status</div>
				<div class="panel-body">
					<canvas id="allChart" width="500" height="100" border="0"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>

	<script type="text/javascript">
		var tempChartData;
		var arusChartData;
		var batChartData;
		readAll();
		redrawChart();

		// read all 3 logfiles
		function readAll() {
			var tempData;
			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-temp.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				tempData = $.csv.toObjects(response);
			  }   
			});

			var arusData;
			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-arus.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				arusData = $.csv.toObjects(response);
			  }   
			});

			var batData;
			$.ajax({
			  type: "GET",  
			  url: "log/2018-10-bat.csv",
			  dataType: "text",
			  async: false,
			  success: function(response)  
			  {
				batData = $.csv.toObjects(response);
			  }   
			});

			var textWidget = document.getElementById("currentTemp");
			textWidget.textContent = (Math.round(parseFloat(tempData[tempData.length-1].temperature) * 100) / 100)+'\u00B0'+'C';
			
			var textWidget = document.getElementById("currentArus");
			textWidget.textContent = (Math.round(parseFloat(arusData[arusData.length-1].arus) * 100) / 100)+' A';
			
			var textWidget = document.getElementById("currentBat");
			textWidget.textContent = (Math.round(parseFloat(batData[batData.length-1].battery) * 100) / 100)+' %';

			tempChartData = generateChartData(tempData);
			arusChartData = generateChartData(arusData);
			batChartData = generateChartData(batData);

			// redrawChart(tempChartData, arusChartData, batChartData);
			console.log('widget');
			setTimeout(readAll, 5000);
			// redrawChart(tempChartData, arusChartData, batChartData);
		}

		// read csv file untuk temperatur
		function generateChartData(data) {
			var dataChart = [];
			var counter = 0;
			// get only 1st data on every minute(s) for 60 data
			// get current datetime
			var now = new Date();
			var c = now.getMinutes();
			for (var i = data.length-720; i < data.length; i++) {
				dataChart[counter] = data[i];
				if(data[i].time.substring(14,16) != c) {
					dataChart[counter] = data[i];
					c = data[i].time.substring(14,16);
					counter++;
				}
			}

			return dataChart;
		}

		// console.log(tempChartData);
		// redrawChart(tempChartData, arusChartData, batChartData);
		// redrawChart();
		function redrawChart() {
			var ctx = document.getElementById("allChart").getContext('2d');
		    var lineChartData = {
		    	labels :  tempChartData.map(function (a) { return a.time.substring(11,16); }),
		    	datasets : [
		    		{
		    			label : "Temperatur",
		    			data : tempChartData.map(function (a) { return a.temperature; }),
		    			fill : false, 
		    			borderColor : 'rgb(75, 192, 192)',
		    			lineTension : 0.1
		    		},
		    		{
		    			label : "Arus",
		    			data : arusChartData.map(function (a) { return a.arus; }),
		    			fill : false, 
		    			borderColor : 'rgb(255, 153, 58)',
		    			lineTension : 0.1
		    		},
		    		{
		    			label : "Baterai",
		    			data : batChartData.map(function (a) { return a.battery; }),
		    			fill : false, 
		    			borderColor : 'rgb(155, 66, 244)',
		    			lineTension : 0.1
		    		}
	    		]
		    };
			var createChart = new Chart(ctx, {
		        type: 'line',
		        data: lineChartData,
		        options: {
			        tooltips: {
			            mode: 'nearest'
			        },
			        hover: {
			        	mode: 'nearest'
			    	}
			    }
		    });
			console.log(tempChartData.length);
		    setTimeout(redrawChart, 30000);
		}

	</script>
    
  </body>
</html>
